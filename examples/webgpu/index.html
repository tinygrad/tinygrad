<html>
	<head>
		<title>Efficientnet</title>
		<script src="./net.js"></script>
	</head>
	<body>
		<p id="result">None</p>
		<input type="file" /> <br /><canvas id="myCanvas" width="224" height="224"></canvas>

		<script>
			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");

			window.addEventListener("load", function () {
				document.querySelector('input[type="file"]').addEventListener("change", function () {
					if (this.files && this.files[0]) {
						var img = new Image();
						img.onload = () => {
							URL.revokeObjectURL(img.src); // no longer needed, free memory

							document.getElementById("result").textContent = "Detecting";

							ctx.drawImage(img, 0, 0, 224, 224);
							console.log(img.width);
							var data = ctx.getImageData(0, 0, 224, 224).data; //.subarray(0 * 224 * 224, 3 * 224 * 224);
							console.log(data);

							run(data);
						};

						img.src = URL.createObjectURL(this.files[0]); // set src to blob url
					}
				});
			});

			const run = async (data) => {
				const getDevice = async () => {
					if (!navigator.gpu) throw Error("WebGPU not supported.");
					const adapter = await navigator.gpu.requestAdapter();
					return await adapter.requestDevice();
				};

				const res = await fetch(
					"https://raw.githubusercontent.com/anishathalye/imagenet-simple-labels/master/imagenet-simple-labels.json"
				);
				const labels = await res.json();
				console.log(labels);

				const device = await getDevice();

				const pix = Array.from(data).map((pix) => (pix / 255.0) * 0.45 - 0.225);
				const inputData = [];
				let i = 0;
				for (let c = 0; c < 3; c++) {
					for (let x = 0; x < 224 * 224; x++) {
						inputData[i] = pix[x * 4 + c];
						i++;
					}
				}
				console.log(inputData);

				console.time("Execution Time");

				const out = await net(device, new Float32Array(inputData));

				console.timeEnd("Execution Time");

				const arr = Array.from(new Float32Array(out));
				console.log(arr);

				const index = arr.indexOf(Math.max(...arr));
				console.log(index);
				console.log(labels[index]);

				const indices = [...arr.keys()].sort((a, b) => arr[b] - arr[a]);
				console.log("10 Biggest:");
				console.log(indices.slice(0, 10));
				for (const index of indices.slice(0, 10)) {
					console.log(labels[index]);
				}

				document.getElementById("result").textContent = labels[index];
			};
		</script>
	</body>
</html>
