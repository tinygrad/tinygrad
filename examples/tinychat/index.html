<!DOCTYPE html>

<head>
  <title>tinychat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script defer src="https://cdn.jsdelivr.net/npm/@alpine-collective/toolkit@1.0.2/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer
    src="https://cdn.jsdelivr.net/npm/@marcreichel/alpine-auto-animate@latest/dist/alpine-auto-animate.min.js"></script>
  <script defer
    src="https://cdn.jsdelivr.net/npm/@marcreichel/alpine-autosize@latest/dist/alpine-autosize.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs-swipe@1.0.2/dist/cjs.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/dompurify@3.1.5/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <script src="index.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Megrim&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/base-min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/vs2015.min.css">
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="common.css">
</head>

<body>
  <main x-data="state" x-init="console.log(endpoint)">
    <div class="home centered" x-show="home === 0" x-transition x-effect="
      $refs.inputForm.focus();
      if (home === 1) setTimeout(() => home = 2, 100);
      if (home === -1) setTimeout(() => home = 0, 100);
    " @popstate.window="
      if (home === 2) {
        home = -1;
        cstate = { time: null, messages: [] };
      }
    ">
      <h1 class="title megrim-regular">tinychat</h1>
      <div class="histories-container-container">
        <template x-if="histories.length">
          <div class="histories-start"></div>
        </template>
        <div class="histories-container" x-intersect="
          $el.scrollTo({ top: 0, behavior: 'smooth' });
        ">
          <template x-for="_state in histories.toSorted((a, b) => b.time - a.time)">
            <div x-data="{ otx: 0, trigger: 75 }" class="history" @click="
            cstate = _state;
            home = 1;
            // ensure that going back in history will go back to home
            window.history.pushState({}, '', '/');
          " @touchstart="
            otx = $event.changedTouches[0].clientX;
          " @touchmove="
            $el.style.setProperty('--tx', $event.changedTouches[0].clientX - otx);
            $el.style.setProperty('--opacity', 1 - (Math.abs($event.changedTouches[0].clientX - otx) / trigger));
          " @touchend="
            if (Math.abs($event.changedTouches[0].clientX - otx) > trigger) removeHistory(_state);
            $el.style.setProperty('--tx', 0);
            $el.style.setProperty('--opacity', 1);
          ">
              <h3 x-text="new Date(_state.time).toLocaleString()"></h3>
              <p x-text="$truncate(_state.messages[0].content, 80)"></p>
              <!-- delete button -->
              <button class="history-delete-button" @click.stop="removeHistory(_state);">
                <i class=" fas fa-trash"></i>
              </button>
            </div>
          </template>
        </div>
        <template x-if="histories.length">
          <div class="histories-end"></div>
        </template>
      </div>
    </div>
    <div class="messages" x-init="
      $watch('cstate', value => {
        $el.innerHTML = '';
        value.messages.forEach(({ role, content }) => {
          const div = document.createElement('div');
          div.className = `message message-role-${role}`;
          div.innerHTML = DOMPurify.sanitize(marked.parse(content));

          // add a clipboard button to all code blocks
          const codeBlocks = div.querySelectorAll('.hljs');
          codeBlocks.forEach(codeBlock => {
            const button = document.createElement('button');
            button.className = 'clipboard-button';
            button.innerHTML = '<i class=\'fas fa-clipboard\'></i>';
            button.onclick = () => {
              navigator.clipboard.writeText(codeBlock.textContent);
              button.innerHTML = '<i class=\'fas fa-check\'></i>';
              setTimeout(() => button.innerHTML = '<i class=\'fas fa-clipboard\'></i>', 1000);
            };
            codeBlock.appendChild(button);
          });

          $el.appendChild(div);
        });

        $el.scrollTo({ top: $el.scrollHeight, behavior: 'smooth' });
      });
    " x-intersect="
      $el.scrollTo({ top: $el.scrollHeight, behavior: 'smooth' });
    " x-show="home === 2" x-transition>
    </div>
    <div class="input-container">
      <div class="input">
        <textarea x-ref="inputForm" id="input-form" class="input-form" autofocus rows=1 x-autosize
          :placeholder="generating ? 'Generating...' : 'Say something'" :disabled="generating" @input="
            home = (home === 0) ? 1 : home
            if (cstate.messages.length === 0 && $el.value === '') home = -1;
          " x-effect="
            console.log(generating);
            if (!generating) $nextTick(() => $el.focus());
          " @keydown.enter="await handleEnter($event)" @keydown.escape.window="$focus.focus($el)"></textarea>
        <button class="input-button" :disabled="generating" @click="await handleSend()">
          <i class="fas" :class="generating ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
        </button>
      </div>
    </div>
  </main>
</body>

</html>
