# CStyle Implementation Details

`tinygrad/renderer/cstyle.py` provides the base class for all C-like language renderers (C, CUDA, Metal, OpenCL, WGSL).

## 1. `CStyleLanguage` Class

Inherits from `Renderer`. It standardizes the generation of C-syntax code.

### 1.1 `render_kernel`
The main template driver.
1.  **Prefix**: Includes headers (`#include`) and defines helper macros (e.g., `INFINITY`).
2.  **Signature**: Generates function signature `__kernel void name(args...)`.
    *   Iterates `bufs` to create arguments. Handles `const` qualifiers and type pointers.
3.  **Body**: Joins the list of code lines (`kernel`) generated by `_render`.

### 1.2 `_render`
Iterates the UOp graph to generate the body lines.
*   **Variable Naming**: Assigns names to UOps (`alu0`, `const1`, `ridx0`).
*   **Rewriting**: Calls `string_rewrite` (PatternMatcher) to convert UOps to strings.
*   **Depth Management**: Tracks indentation for `IF` / `RANGE` (loops).
*   **SSA Handling**: Decides whether to inline an expression or assign it to a variable.
    *   Inlines: `CONST`, `GEP`, simple ALU ops used once.
    *   Variables: `LOAD`, expensive ALU, shared memory definitions.

### 1.3 `base_rewrite`
Defines standard patterns for C:
*   **`Ops.ADD`**: `(a + b)`
*   **`Ops.IF`**: `if (cond) {`
*   **`Ops.RANGE`**: `for (int i = 0; i < end; i++) {`
*   **`Ops.DEFINE_LOCAL`**: `__local float data[size];`
*   **`Ops.BARRIER`**: `barrier(...)`

## 2. Type Handling

*   **`render_dtype`**: Converts `DType` to C string.
    *   Scalar: `float`, `int`, `half`.
    *   Vector: `float4`, `short2` (mapped via `type_map` or `ext_vector_type`).
    *   Pointer: `float*`, `global float*`.
    *   Image: `image2d_t`.
*   **`render_cast`**: Generates `(type)(value)`.

## 3. Subclasses

### 3.1 `ClangRenderer` (CPU)
*   **Target**: C code compiled by Clang.
*   **Features**:
    *   `has_local = False` (no shared memory).
    *   `float4` via `ext_vector_type`.
    *   `AMX` support (Tensor Cores on CPU) via inline assembly.

### 3.2 `OpenCLRenderer`
*   **Target**: OpenCL C.
*   **Features**:
    *   `kernel_typedef = "__kernel void"`.
    *   `buffer_prefix = "__global "`.
    *   `get_global_id(0)` for indexing.
    *   Image load/store intrinsics (`read_imagef`).

### 3.3 `MetalRenderer`
*   **Target**: Metal Shading Language (C++14 based).
*   **Features**:
    *   `simdgroup_matrix` (WMMA) support.
    *   Strict type casting (`as_type<float>`).
    *   `thread_position_in_grid`.

### 3.4 `CUDARenderer`
*   **Target**: NVIDIA CUDA C++.
*   **Features**:
    *   `extern "C" __global__`.
    *   `mma.sync` (Tensor Cores) via inline PTX (`asm(...)`).
    *   FP8 support (`__nv_fp8_e4m3`).
    *   `__launch_bounds__` optimization.

### 3.5 `AMDHIPRenderer`
*   **Target**: AMD HIP (ROCcm).
*   **Features**:
    *   `__builtin_amdgcn_mfma` (Matrix Fused Multiply Add) for CDNA.
    *   `__builtin_amdgcn_wmma` for RDNA3/4.
    *   Specific flat workgroup size attributes.

## 4. Tensor Cores (`wmma_args`)

*   Detects `Ops.WMMA`.
*   Generates a helper function (e.g., `__mma_m16n8k16`) that wraps the hardware intrinsic.
*   Handles loading/storing data into registers required by the matrix instruction.
